# CNUCNM_v23 Shiny 앱 기술적 분석

## 📋 앱 개요

- **URL**: https://cnudairy.shinyapps.io/CNUCNM_v23/
- **플랫폼**: R Shiny (shinyapps.io)
- **아키텍처**: Shiny 입력 → R 프로그램 → Shiny 결과 보고
- **버전**: v23

## 🔄 작동 구조

### 1. Shiny 입력 단계 (Input Phase)
사용자가 웹 인터페이스를 통해 데이터를 입력합니다.

#### 동물 정보 입력
```r
# Shiny UI에서 입력받는 데이터
animal_data <- list(
  breed = input$breed,           # 품종 (홀스타인/한우)
  stage = input$stage,           # 생리단계 (착유우/건유우/육성우/비육우/송아지)
  gender = input$gender,         # 성별 (경산우/미경산우/거세우)
  age = input$age,               # 월령
  lactation_day = input$lactation_day,  # 착유일
  pregnancy_day = input$pregnancy_day,  # 임신일
  body_weight = input$body_weight,      # 생체중(kg)
  mature_weight = input$mature_weight,  # 체성숙체중
  birth_weight = input$birth_weight,    # 생시체중
  first_calving_age = input$first_calving_age,  # 초산월령
  calving_interval = input$calving_interval,    # 분만간격(월)
  bcs = input$bcs                 # BCS(1-9)
)
```

#### 생산성 정보 입력
```r
production_data <- list(
  milk_yield = input$milk_yield,        # 유량(kg)
  milk_fat = input$milk_fat,            # 유지방(%)
  milk_protein = input$milk_protein,    # 유단백(%)
  target_adg = input$target_adg         # 목표 일당증체량(kg)
)
```

#### 환경 정보 입력
```r
environment_data <- list(
  last_month_temp = input$last_month_temp,    # 지난달 온도
  current_temp = input$current_temp,          # 현재 온도
  wind_speed = input$wind_speed,              # 풍속(시속)
  tropical_night = input$tropical_night,      # 열대야?
  barn_mud = input$barn_mud,                  # 우사 진흙(cm)
  area = input$area,                          # 사육면적(m²)
  tie_stall = input$tie_stall,                # 계류사 유형
  last_month_humidity = input$last_month_humidity,  # 지난달 습도
  current_humidity = input$current_humidity,        # 현재 습도
  sun_exposure = input$sun_exposure,               # 직사광선 노출(시간)
  panting_level = input$panting_level,             # 헐떡임 정도
  body_surface = input$body_surface                # 몸표면 상태
)
```

#### 사료 선택 입력
```r
feed_selection <- list(
  mixed_feeds = input$mixed_feeds,      # 배합사료 선택
  roughages = input$roughages,          # 조사료 선택
  starches = input$starches,            # 전분질 선택
  lipids = input$lipids,                # 지질 선택
  proteins = input$proteins,            # 단백질 선택
  fibers = input$fibers,                # 섬유질 선택
  supplements = input$supplements       # 보조사료 선택
)
```

### 2. R 프로그램 처리 단계 (Processing Phase)
입력된 데이터를 R 프로그램이 처리합니다.

#### 데이터 전처리
```r
# 입력 데이터 검증 및 전처리
validate_inputs <- function(animal_data, production_data, environment_data) {
  # 데이터 타입 검증
  # 범위 검증
  # 필수 입력 확인
  # 데이터 정규화
}

# 환경 스트레스 계산
calculate_environmental_stress <- function(environment_data) {
  # 온도 스트레스
  # 습도 스트레스
  # 풍속 스트레스
  # 열 스트레스 지수 계산
}
```

#### 영양 요구량 계산
```r
# NASEM (2024) 기준 영양 요구량 계산
calculate_nutrition_requirements <- function(animal_data, production_data, environment_data) {
  # 체중 변환 (FBW → SBW → EBW → MBW)
  weight_conversion <- convert_weight(animal_data$body_weight)
  
  # 유지 요구량 계산
  maintenance_requirements <- calculate_maintenance(weight_conversion$mbw, environment_data)
  
  # 생산 요구량 계산
  production_requirements <- calculate_production(
    animal_data, 
    production_data, 
    weight_conversion
  )
  
  # 총 영양 요구량
  total_requirements <- maintenance_requirements + production_requirements
  
  return(total_requirements)
}
```

#### 사료 배합 최적화
```r
# 선형계획법을 이용한 사료 배합 최적화
optimize_feed_formulation <- function(requirements, feed_library, constraints) {
  # 목적함수: 최소 비용
  objective_function <- "minimize_cost"
  
  # 제약조건
  constraints <- list(
    nutrient_requirements = requirements,
    intake_limits = calculate_intake_limits(animal_data),
    feed_availability = feed_library$availability,
    nutrient_balance = feed_library$nutrient_composition
  )
  
  # 선형계획법 실행
  result <- solve_lp(objective_function, constraints)
  
  return(result)
}
```

### 3. Shiny 결과 보고 단계 (Output Phase)
R 프로그램의 결과를 Shiny UI로 표시합니다.

#### 결과 데이터 구조
```r
# 계산 결과를 Shiny 출력용으로 구조화
output_results <- list(
  # 섭취량 예측
  intake_prediction = list(
    dry_matter_intake = calculated_dmi,
    feed_intake_by_category = feed_intake_breakdown
  ),
  
  # 동물 정보 요약
  animal_summary = list(
    breed = animal_data$breed,
    stage = animal_data$stage,
    weight = animal_data$body_weight,
    age = animal_data$age
  ),
  
  # 생산성 예측
  production_prediction = list(
    expected_milk_yield = predicted_milk_yield,
    expected_weight_gain = predicted_weight_gain,
    production_efficiency = calculated_efficiency
  ),
  
  # 사료 배합비
  feed_formulation = list(
    feed_ratios = optimal_feed_ratios,
    daily_amounts = daily_feed_amounts,
    cost_analysis = feed_cost_analysis
  ),
  
  # 영양소 요구량
  nutrient_requirements = list(
    energy_requirements = energy_req,
    protein_requirements = protein_req,
    mineral_requirements = mineral_req,
    vitamin_requirements = vitamin_req
  ),
  
  # 영양소 제한 조건
  nutrient_constraints = list(
    min_max_values = constraint_limits,
    constraint_status = constraint_satisfaction
  ),
  
  # 최적화 결과
  optimization_results = list(
    objective_value = total_cost,
    solution_status = optimization_status,
    sensitivity_analysis = sensitivity_results
  ),
  
  # 사료 조성 (건물 기준)
  feed_composition = list(
    nutrient_composition = calculated_composition,
    dry_matter_basis = dm_basis_composition
  )
)
```

#### Shiny UI 출력
```r
# Shiny Server에서 결과 출력
output$intake_tab <- renderUI({
  # 섭취량 탭 UI 생성
  create_intake_ui(output_results$intake_prediction)
})

output$animal_info_tab <- renderUI({
  # 동물 정보 탭 UI 생성
  create_animal_info_ui(output_results$animal_summary)
})

output$production_prediction_tab <- renderUI({
  # 생산성 예측 탭 UI 생성
  create_production_ui(output_results$production_prediction)
})

output$feed_formulation_tab <- renderUI({
  # 사료 배합비 탭 UI 생성
  create_formulation_ui(output_results$feed_formulation)
})

output$nutrient_requirements_tab <- renderUI({
  # 영양소 요구량 탭 UI 생성
  create_requirements_ui(output_results$nutrient_requirements)
})

output$constraints_tab <- renderUI({
  # 영양소 제한 조건 탭 UI 생성
  create_constraints_ui(output_results$nutrient_constraints)
})

output$optimization_tab <- renderUI({
  # 최적화 결과 탭 UI 생성
  create_optimization_ui(output_results$optimization_results)
})

output$composition_tab <- renderUI({
  # 사료 조성 탭 UI 생성
  create_composition_ui(output_results$feed_composition)
})
```

## 🔧 기술적 특징

### 1. 실시간 반응성
- **Reactive Programming**: Shiny의 반응형 프로그래밍 모델 사용
- **즉시 계산**: 입력 변경 시 즉시 결과 업데이트
- **상태 관리**: 입력 상태와 계산 상태 분리 관리

### 2. 모듈화된 구조
```r
# 모듈별 분리
- animal_input_module.R      # 동물 정보 입력 모듈
- production_input_module.R  # 생산성 정보 입력 모듈
- environment_input_module.R # 환경 정보 입력 모듈
- feed_selection_module.R    # 사료 선택 모듈
- calculation_module.R       # 계산 처리 모듈
- optimization_module.R      # 최적화 모듈
- output_module.R           # 결과 출력 모듈
```

### 3. 데이터 흐름
```
사용자 입력 → 데이터 검증 → 전처리 → 계산 → 최적화 → 결과 생성 → UI 업데이트
```

### 4. 에러 처리
```r
# 입력 검증
validate_inputs <- function(input_data) {
  tryCatch({
    # 데이터 검증 로직
    validate_data_types(input_data)
    validate_ranges(input_data)
    validate_required_fields(input_data)
  }, error = function(e) {
    # 에러 처리
    show_error_message(e$message)
  })
}

# 계산 에러 처리
safe_calculation <- function(calculation_function, ...) {
  tryCatch({
    calculation_function(...)
  }, error = function(e) {
    # 계산 실패 시 기본값 반환
    return(default_values)
  })
}
```

## 📊 성능 최적화

### 1. 계산 최적화
- **캐싱**: 동일한 입력에 대한 계산 결과 캐싱
- **지연 계산**: 필요한 시점에만 계산 실행
- **병렬 처리**: 독립적인 계산은 병렬로 처리

### 2. 메모리 관리
- **데이터 정리**: 불필요한 데이터 즉시 해제
- **메모리 모니터링**: 메모리 사용량 추적
- **가비지 컬렉션**: 주기적 메모리 정리

## 🔒 보안 및 안정성

### 1. 입력 검증
- **데이터 타입 검증**: 올바른 데이터 타입 확인
- **범위 검증**: 허용 범위 내 값 확인
- **필수 입력 확인**: 필수 입력값 누락 확인

### 2. 계산 안정성
- **수치 안정성**: 부동소수점 계산 오차 방지
- **수렴성 확인**: 최적화 알고리즘 수렴 확인
- **예외 처리**: 계산 실패 시 적절한 처리

## 📈 확장성

### 1. 모듈 확장
- **새로운 사료 추가**: 사료 라이브러리 확장 가능
- **새로운 계산 모델**: 계산 모듈 추가 가능
- **새로운 출력 형식**: 결과 출력 형식 확장 가능

### 2. 성능 확장
- **클라우드 배포**: shinyapps.io에서 클라우드 확장
- **로드 밸런싱**: 다중 사용자 지원
- **데이터베이스 연동**: 외부 데이터베이스 연동 가능

## 🎯 결론

CNUCNM_v23 Shiny 앱은 **Shiny 입력 → R 프로그램 → Shiny 결과 보고**의 전형적인 R Shiny 아키텍처를 따르며, 실시간 반응성과 모듈화된 구조를 통해 사용자 친화적인 축우 정밀사양 시스템을 제공합니다.

이 구조는 복잡한 영양 계산과 최적화를 웹 기반으로 접근 가능하게 만들어, 전문가뿐만 아니라 일반 사용자도 쉽게 활용할 수 있도록 설계되었습니다.
